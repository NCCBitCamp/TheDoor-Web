<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phaser Dialog Game</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: 'KyoboHandwriting2023wsa', sans-serif;
    }
    canvas {
      display: block;
    }
    @font-face {
      font-family: 'KyoboHandwriting2023wsa';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2404-2@1.0/KyoboHandwriting2023wsa.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }
  </style>
</head>

<body>
  <div id="game-container"></div>

  <script>
    const config = {
      type: Phaser.AUTO,
      width: 1280,
      height: 720,
      parent: 'game-container',
      scene: {
        preload: preload,
        create: create,
        update: update
      }
    };

    const game = new Phaser.Game(config);
    let dialogueText, backgrounds, currentBackgroundIndex = 0;

    function preload() {
      this.load.image('background1', 'images/wake01.png');
      this.load.image('background2', 'images/mySeat.png');
      this.load.image('background3', 'images/room502.png');
      this.load.image('background4', 'images/room502door.png');
      this.load.image('dialogueBox', 'images/wallpaper-torn-paper-ripped-white-paper.png');
    }

    function create() {
      backgrounds = [
        this.add.image(config.width / 2, config.height / 2, 'background1').setDisplaySize(config.width, config.height),
        this.add.image(config.width / 2, config.height / 2, 'background2').setDisplaySize(config.width, config.height).setAlpha(0),
        this.add.image(config.width / 2, config.height / 2, 'background3').setDisplaySize(config.width, config.height).setAlpha(0),
        this.add.image(config.width / 2, config.height / 2, 'background4').setDisplaySize(config.width, config.height).setAlpha(0),
      ];

      const dialogueBox = this.add.image(72, 500, 'dialogueBox').setOrigin(0);

      const texts1 = ["여긴 어디지..."];
      const texts2 = ["뭔가 익숙한... 내 자리?", "학원에서 공부하다가 깜박 잠들었구나"];
      const texts3 = ["얼마나 잔거지?", "불까지 전부 꺼져있는 걸 보니 한참을 잔 모양이다.", "경비원 아저씨가 내가 있는지 모르고 꺼버리신 걸까?", "어쨌든 늦었으니 빨리 집으로 돌아가자.", "...어라?", "문이 열리지 않는다.", "잘보니 문에 못보던 자물쇠가 달려있는 게 눈에 띄인다.", "\"이게 대체 무슨...\""];
      const texts4 = ["문을 열어보려 했지만 강철문처럼 꼼짝도 하지 않는다."];
      const texts5 = ["일단 주위에 쓸만한 물건이 없는지 살펴보자."];

      let currentIndex = 0;
      let currentTexts = texts1;

      dialogueText = this.add.text(config.width / 2, config.height - 100, '', {
        fontFamily: 'KyoboHandwriting2023wsa',
        fontSize: '35px',
        fill: '#000000'
      }).setOrigin(0.5).setAlign('center');

      // 현재 배경을 페이드아웃하는 함수
      const fadeOutCurrentBackground = () => {
        return this.tweens.add({
          targets: backgrounds[currentBackgroundIndex],
          alpha: 0,
          duration: 1000,
        });
      };

      // 다음 배경을 페이드인하는 함수
      const fadeInNextBackground = (nextIndex) => {
        currentBackgroundIndex = nextIndex;
        backgrounds[currentBackgroundIndex].setAlpha(0); // 미리 배경을 투명하게 설정
        return this.tweens.add({
          targets: backgrounds[currentBackgroundIndex],
          alpha: 1,
          duration: 1000,
          onComplete: () => {
            // 텍스트 할당 로직을 조건에 따라 수정
            switch (currentBackgroundIndex) {
              case 1:
                currentTexts = texts2;
                break;
              case 2:
                // texts5가 출력되어야 하는 조건을 추가하여 오류 수정
                currentTexts = currentTexts === texts4 ? texts5 : texts3;
                break;
              case 3:
                currentTexts = texts4;
                break;
              default:
                currentTexts = [];
            }
            currentIndex = 0;
            dialogueText.setText('');
          }
        });
      };

      // 텍스트와 배경을 관리하는 로직
      this.input.on('pointerdown', () => {
        if (currentIndex < currentTexts.length) {
          dialogueText.setText(currentTexts[currentIndex]);
          currentIndex++;
        } else {
          if (currentBackgroundIndex === 3 && currentTexts === texts4) { // texts4가 끝나면 background4에서 background3으로 돌아감
            fadeOutCurrentBackground().on('complete', () => {
              fadeInNextBackground(2); // background3을 페이드인
            });
          } else if (currentBackgroundIndex < backgrounds.length - 1) {
            fadeOutCurrentBackground().on('complete', () => {
              fadeInNextBackground(currentBackgroundIndex + 1);
            });
          } else if (currentBackgroundIndex === backgrounds.length - 1 && currentTexts === texts5) {
            // 최종 텍스트 이후 로직 필요
            console.log("End of game sequence, perhaps show ending or credits");
          }
        }
      });
    }

    function update() {
    }
  </script>
</body>
</html>
