<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2층</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'KyoboHandwriting2023wsa', sans-serif;
            cursor: default;
            background-color: rgba(0, 0, 0, 1);
            /* 바깥 배경 어둡게 설정 */
        }

        #game-container {
            position: relative;
            width: 1280px;
            height: 720px;
            margin: 0 auto;
            overflow: hidden;
        }

        .nav-button {
            position: absolute;
            top: 78%;
            transform: translateY(-50%);
            background-color: white;
            color: black;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        #prev-button {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'KyoboHandwriting2023wsa';
        }

        #next-button {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'KyoboHandwriting2023wsa';
        }

        #back-button {
            top: 0%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'KyoboHandwriting2023wsa';
            display: none;
        }

        #settings-button {
            position: absolute;
            top: 18px;
            right: 25px;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        #settings-button img {
            width: 50px;
            height: 50px;
        }

        @font-face {
            font-family: 'KyoboHandwriting2023wsa';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2404-2@1.0/KyoboHandwriting2023wsa.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <button id="prev-button" class="nav-button" onclick="viewSection(-1)"><</button>
                <button id="next-button" class="nav-button" onclick="viewSection(1)">></button>
                <button id="back-button" class="nav-button" style="display:none;" onclick="goBack()">Back</button>
                <button id="settings-button" onclick="openSettings()"><img src="images/settings-icon.svg"
                        alt="Settings"></button>
    </div>

    <script>
        let config = {
            type: Phaser.AUTO,
            width: 1280,
            height: 720,
            parent: 'game-container',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);
        let camera;
        let bgImage;
        let currentSection = 0;
        let totalSections = 3;
        let sectionWidth;
        let dialogBox;
        let dialogText;
        let noteImage;
        let currentLineIndex = 0;
        let clickableZones = []; // 클릭 가능한 영역을 저장할 배열
        let lockedImage;
        let timerText;
        let gameOverText;

        // 인벤토리 관련 변수 및 함수
        let inventory = [];
        let inventoryImages = []; // 소지품 이미지들을 저장할 배열
        let inventoryText, inventoryBag, modal, modalBackground, modalText;
        let modalItems = []; // 모달에 추가된 소지품 이미지들을 저장할 배열

        const createInventory = (scene) => {
            // 가방 이미지 추가
            inventoryBag = scene.add.image(1150, 40, 'bag').setInteractive();
            inventoryBag.setScale(0.5).setScrollFactor(0);
            inventoryBag.on('pointerdown', () => {
                toggleInventoryModal(scene);
            });
            inventoryBag.on('pointerover', () => {
                document.body.style.cursor = 'pointer';
            });
            inventoryBag.on('pointerout', () => {
                document.body.style.cursor = 'default';
            });

            // 모달 창 생성
            modalBackground = scene.add.rectangle(scene.cameras.main.centerX, scene.cameras.main.centerY - 180, 800, 300, 0xFFFAFA).setAlpha(0).setInteractive().setScrollFactor(0); // 배경색 변경 예시
            modalText = scene.add.text(scene.cameras.main.centerX, 60, '소지품', {
                fontFamily: 'KyoboHandwriting2023wsa',
                fontSize: '24px',
                fill: '#000000'
            }).setAlpha(0).setOrigin(0.5).setScrollFactor(0);
            modal = scene.add.container(0, 0, [modalBackground, modalText]).setAlpha(0);
        };

        // 소지품 칸에 아이템을 추가하는 함수
        const addItemToInventory = (item, imageKey) => {
            // 아이템이 이미 소지품에 있는지 확인
            if (!inventory.includes(item)) {
                inventory.push(item);
                inventoryImages.push({ key: imageKey, name: item }); // 소지품 이미지와 이름을 저장
                updateInventoryDisplay();
            } else {
                console.log('아이템이 이미 소지품에 있습니다.');
            }
        };

        // 소지품 칸의 내용을 업데이트하는 함수
        const updateInventoryDisplay = () => {
            if (inventoryText) {
                inventoryText.setText(inventory.map(item => item.name).join('\n'));
            }
        };

        // 아이템 세부 정보를 표시하는 함수
        const showItemDetails = (scene, itemKey) => {
            // 확대해서 보여줄 이미지를 설정
            let enlargedImageKey;
            if (itemKey === 'memo1') {
                enlargedImageKey = 'memo1-1'; // memo1 클릭 시 보여줄 이미지
            } else if (itemKey === 'memo2') {
                enlargedImageKey = 'memo2-1'; // memo2 클릭 시 보여줄 이미지
            }

            // 전체화면 이미지를 추가하고 보이게 설정
            const fullscreenImage = scene.add.image(scene.cameras.main.centerX, scene.cameras.main.centerY, enlargedImageKey)
                .setDisplaySize(scene.cameras.main.width * 0.9, scene.cameras.main.height * 0.9)
                .setAlpha(0)
                .setInteractive();

            scene.tweens.add({
                targets: fullscreenImage,
                alpha: 1,
                duration: 500
            });

            // 클릭 이벤트를 추가하여 이미지를 클릭하면 페이드 아웃하고 제거
            fullscreenImage.on('pointerdown', () => {
                scene.tweens.add({
                    targets: fullscreenImage,
                    alpha: 0,
                    duration: 500,
                    onComplete: () => {
                        fullscreenImage.destroy();
                    }
                });
            });
        };

        // 인벤토리 모달 창을 토글하는 함수
        const toggleInventoryModal = (scene) => {
            if (modal.alpha === 0) {
                // 모달을 보이게 설정
                modal.setAlpha(1);
                modalBackground.setAlpha(0.8);
                modalText.setAlpha(1);

                // 소지품 이미지를 모달에 추가
                inventoryImages.forEach((imageObj, index) => {
                    const itemImage = scene.add.image(scene.cameras.main.centerX - 300 + (index % 4) * 200, scene.cameras.main.centerY - 190 + Math.floor(index / 4) * 140, imageObj.key).setScale(0.3).setScrollFactor(0);
                    const itemText = scene.add.text(scene.cameras.main.centerX - 300 + (index % 4) * 200, scene.cameras.main.centerY - 100 + Math.floor(index / 4) * 140, imageObj.name, {
                        fontFamily: 'KyoboHandwriting2023wsa',
                        fontSize: '25px', // 폰트 크기 조절
                        fill: '#000000'
                    }).setOrigin(0.5).setScrollFactor(0);
                    modal.add([itemImage, itemText]);
                    modalItems.push(itemImage); // 추가된 소지품 이미지를 저장
                    modalItems.push(itemText); // 추가된 소지품 텍스트를 저장

                    // 메모 아이템에 대한 클릭 이벤트 추가
                    if (imageObj.key === 'memo1' || imageObj.key === 'memo2') {
                        itemImage.setInteractive();
                        itemImage.on('pointerdown', () => {
                            showItemDetails(scene, imageObj.key);
                        });
                    }
                });
            } else {
                // 모달을 숨김
                modal.setAlpha(0);
                modalBackground.setAlpha(0);
                modalText.setAlpha(0);

                // 모달에 추가된 소지품 이미지를 제거
                modalItems.forEach(item => item.destroy());
                modalItems = []; // 소지품 이미지 배열 초기화
            }
        };

        function showDialogue(texts) {
            let currentTextIndex = 0;

            const advanceText = () => {
                if (currentTextIndex < texts.length) {
                    dialogText.setText(texts[currentTextIndex]);
                    dialogBox.setVisible(true);
                    dialogText.setVisible(true);
                    currentTextIndex++;
                } else {
                    dialogBox.setVisible(false);
                    dialogText.setVisible(false);
                }
            };

            advanceText(); // 첫 번째 텍스트를 표시

            dialogBox.setInteractive().on('pointerdown', () => {
                advanceText();
            });
        }

        function showLockedImage() {
            // locked 이미지 중앙에 위치시키고 화면에 꽉 차게 스케일 조정
            lockedImage.setPosition(camera.scrollX + config.width / 2, camera.scrollY + config.height / 2);
            lockedImage.setDisplaySize(config.width, config.height);
            lockedImage.setVisible(true);

            document.getElementById('back-button').style.display = 'none';

            // 타이머 시작
            startTimer(10); // 2분 (120초)
        }

        // 타이머 표시를 위한 요소 생성
        function createTimer(scene) {
            timerText = scene.add.text(config.width - 100, 50, '', {
                fontFamily: 'KyoboHandwriting2023wsa',
                fontSize: '32px',
                fill: '#ff0000'
            }).setOrigin(0.5).setScrollFactor(0).setVisible(false);
        }

        function startTimer(duration) {
            let timer = duration;
            timerText.setVisible(true);

            const timerInterval = setInterval(() => {
                let minutes = Math.floor(timer / 60);
                let seconds = timer % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;

                timerText.setText(`${minutes}:${seconds}`);
                timer--;

                if (timer < 0) {
                    clearInterval(timerInterval);
                    showGameOver();
                }
            }, 1000);
        }

        function showGameOver() {
            let graphics = game.scene.scenes[0].add.graphics();
            graphics.fillStyle(0x000000, 1);
            graphics.fillRect(0, 0, config.width, config.height);

            gameOverText = game.scene.scenes[0].add.text(config.width / 2, config.height / 2, 'Game over', {
                fontFamily: 'KyoboHandwriting2023wsa',
                fontSize: '64px',
                fill: '#ffffff'
            }).setOrigin(0.5).setScrollFactor(0);

            setTimeout(() => {
                window.location.href = 'floor2.html';
            }, 3000);
        }

        // 공통 클릭 영역 생성 함수
        function createClickableZone(scene, x, y, width, height, clickHandler) {
            const zone = scene.add.zone(x, y, width, height).setOrigin(0.5).setInteractive();
            zone.on('pointerover', () => {
                document.body.style.cursor = 'pointer';
            });
            zone.on('pointerout', () => {
                document.body.style.cursor = 'default';
            });
            zone.on('pointerdown', () => {
                clickHandler();
            });
            clickableZones.push(zone); // 클릭 가능한 영역을 배열에 추가
        }

        // 클릭 가능한 영역을 모두 제거하는 함수
        function clearClickableAreas() {
            clickableZones.forEach(zone => zone.destroy());
            clickableZones = [];
        }

        // 클릭 가능한 영역을 생성하는 함수
        function createClickableAreas(scene) {
            // 유리실 클릭 영역
            createClickableZone(scene, 1080, 255, 470, 310, () => {
                changeBackground(scene, 'locked'); // 배경 이미지 변경
                hideNavButtons(); // 좌우 버튼 숨기기
                showBackButton(); // 뒤로 가기 버튼 보이기
                showLockedImage(); // locked 이미지 보여주기
            });
            // 강의실1 클릭 영역
            createClickableZone(scene, 220, 310, 120, 200, () => showDialogue(["창문 틈으로 교실이 보인다.", "시설이 좋아보이는 강의실이다...", "...", "엄청난 컴퓨터다..."]));

            // 강의실2 클릭 영역
            createClickableZone(scene, 405, 310, 120, 200, () => showDialogue(["강의실 내부가 조금 보인다.", "근사해보이는 강의실...", "의자가 편해보인다.", "문이 잠겨있어 들어갈 수는 없다."]));

            // 강의실3 클릭 영역
            createClickableZone(scene, 600, 310, 120, 200, () => showDialogue(["문이 잠겨있지만 창문으로 안이 보인다.", "...대단해보이는 강의실이다.", "자리가 넓어보인다.", "..."]));

            // 비상계단 클릭 영역
            createClickableZone(scene, 1565, 282.5, 130, 255, () => showDialogue(["비상계단의 문이 굳게 닫혀있다.", "이전처럼 문을 열 수 있는 방법이 없을까?"]));

            // 엘리베이터 클릭 영역
            createClickableZone(scene, 1944, 310, 346, 200, () => showDialogue(["엘리베이터다.", "움직이지 않을 것을 알기에 더이상 버튼은 누르지 않는다.", "어떻게 작동시킬 수 있지?"]));
        }

        // 배경 이미지 변경 함수
        function changeBackground(scene, textureKey) {
            clearClickableAreas(); // 기존 클릭 가능한 영역 제거
            bgImage.setTexture(textureKey); // 배경 이미지 변경
            let scaleX = config.width / bgImage.width;
            let scaleY = config.height / bgImage.height;
            let scale = Math.max(scaleX, scaleY);
            bgImage.setScale(scale).setOrigin(0, 0); // 화면 꽉 차게 스케일 조정

            // 커서를 기본값으로 되돌리기
            document.body.style.cursor = 'default';
        }

        // 좌우 버튼 숨기기 함수
        function hideNavButtons() {
            document.getElementById('prev-button').style.display = 'none';
            document.getElementById('next-button').style.display = 'none';
        }

        // 뒤로가기 버튼 표시 함수
        function showBackButton() {
            document.getElementById('back-button').style.display = 'block';
        }
        
        function hideLockedImage() {
            lockedImage.setVisible(false);
            timerText.setVisible(false); // 타이머 숨기기
        }

        // 뒤로가기 버튼 기능 함수
        function goBack() {
            bgImage.setTexture('background'); // 원래 배경 이미지로 변경
            let scaleX = config.width / bgImage.width;
            let scaleY = config.height / bgImage.height;
            let scale = Math.max(scaleX, scaleY);
            bgImage.setScale(scale).setOrigin(0, 0); // 화면 꽉 차게 스케일 조정
            document.getElementById('back-button').style.display = 'none'; // 뒤로 가기 버튼 숨기기
            document.getElementById('prev-button').style.display = 'block'; // 좌우 버튼 다시 보이기
            document.getElementById('next-button').style.display = 'block';
            createClickableAreas(game.scene.scenes[0]); // 클릭 가능한 영역 다시 생성

            // 커서를 기본값으로 되돌리기
            document.body.style.cursor = 'default';

            // locked 이미지 숨기기
            hideLockedImage();
        }

        function preload() {
            this.load.image('background', 'images/2floorBD.png');
            this.load.image('locked', 'images/locked.png');
            this.load.image('dialogueBox', 'images/wallpaper-torn-paper-ripped-white-paper.png');
            this.load.image('bag', 'images/bag.svg');
        }

        function create() {
            bgImage = this.add.image(0, 0, 'background').setOrigin(0, 0);

            let scaleX = config.width / bgImage.width;
            let scaleY = config.height / bgImage.height;
            let scale = Math.max(scaleX, scaleY);

            bgImage.setScale(scale).setOrigin(0, 0);

            camera = this.cameras.main;
            camera.setViewport(0, 0, config.width, config.height);

            sectionWidth = (bgImage.displayWidth - config.width) / (totalSections - 1);

            dialogBox = this.add.image(config.width / 2, 530, 'dialogueBox').setOrigin(0.5, 0).setInteractive();
            dialogBox.setVisible(false);

            dialogText = this.add.text(config.width / 2, config.height - 70, '', {
                fontFamily: 'KyoboHandwriting2023wsa',
                fontSize: '35px',
                fill: '#000000',
                wordWrap: { width: 1000, useAdvancedWrap: true }
            }).setOrigin(0.5).setAlign('center');
            dialogText.setVisible(false);

            // locked 이미지 생성 및 숨기기
            lockedImage = this.add.image(config.width / 2, config.height / 2, 'locked').setOrigin(0.5).setVisible(false);

            createInventory(this);  // 소지품 칸 초기화 호출
            createTimer(this); // 타이머 생성

            createClickableAreas(this); // 클릭 가능한 영역 생성
        }

        function update() {
            dialogBox.x = camera.scrollX + config.width / 2;
            dialogBox.y = camera.scrollY + 530;

            dialogText.x = camera.scrollX + config.width / 2;
            dialogText.y = camera.scrollY + config.height - 70;

            // locked 이미지 위치 업데이트
            lockedImage.x = camera.scrollX + config.width / 2;
            lockedImage.y = camera.scrollY + config.height / 2;

            // 타이머 위치 업데이트
            timerText.x = camera.scrollX + config.width - 1200;
            timerText.y = camera.scrollY + 50;
        }

        function viewSection(direction) {
            if (dialogBox.visible) return;

            currentSection += direction;
            if (currentSection < 0) currentSection = 0;
            if (currentSection >= totalSections) currentSection = totalSections - 1;

            camera.scrollX = sectionWidth * currentSection;
            camera.scrollY = 0;
        }
    </script>
</body>

</html>
