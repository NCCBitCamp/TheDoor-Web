<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7층 배경</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <link rel="stylesheet" type="text/css" href="floor7.css">
</head>
<body>
    <div id="game-container">
        <button id="prev-button" class="nav-button" onclick="viewSection(-1)"><</button>
        <button id="next-button" class="nav-button" onclick="viewSection(1)">></button>
        <button id="back-button" class="nav-button" style="display:none;" onclick="goBack()">
            <img src="images/back_button.svg" alt="Back">
        </button>
        <button id="settings-button" onclick="openSettings()"><img src="images/settings-icon.svg" alt="Settings"></button>
    </div>
    <input type="text" id="inputBox" placeholder="번호를 입력하세요" />
    <button id="submitButton">입력</button>

    <script>
    let config = {
        type: Phaser.AUTO,
        width: 1280,
        height: 720,
        parent: 'game-container',
        scene: {
            preload: preload,
            create: create,
            update: update // update 함수 추가
        }
    };

    const game = new Phaser.Game(config);
    let camera;
    let bgImage;
    let currentSection = 0;
    let totalSections = 3;
    let sectionWidth;
    let dialogBox;
    let dialogText;
    let noteImage;
    let currentTexts = [];
    let currentLineIndex = 0;
    let clickableZones = []; // 클릭 가능한 영역을 저장할 배열
    const texts1 = ["학원의 학생들과 강사님이 사용하는 사물함이다.", "강사님의 말씀대로라면 분명 이 중 한 곳에 2층 열쇠가 있을거다.", "몇 번 사물함을 조사해볼까?", "조사할 사물함의 번호를 입력해주세요.(101 ~ 303)"];
    const texts2 = ["식사시간에 자주 이용하던 전자레인지다.", "...", "?", "전자레인지 안 쪽에 유리병 하나가 있다.", "[수상한 유리병]을 획득했다.", "대체 누가 이런 곳에 둔걸까?"];
    const texts3_1 = ["깨끗이 정돈된 테이블이다.", "잘 보니 "];
    const texts3_2 = ["조금 더럽고 낡은 테이블이다.", "잘 보니 테이블 구석에 누군가 낙서를 해둔 게 보인다.", "\"요새 \""];
    const texts3_3 = ["?", "7층에 이런 게시판이 있었던가?", "뭐라고 써있는지 살펴볼까?"];
    const texts4 = ["아직 2층 열쇠를 얻지 못했다. 좀 더 조사해보자."];
    const texts5 = ["엘리베이터는 아직도 작동할 기미가 보이지 않는다.", "언제쯤 여기서 빠져나갈 수 있을까.."];
    const textsMap = {
        "101": ["101번 사물함을 조사한다.", "...", "사물함은 텅텅 비어있다."],
        "102": ["102번 사물함을 조사한다.", "...", "몇 개의 책들이 들어있다.", "지금 필요한 물건은 아닌 것 같다."],
        "103": ["103번 사물함을 조사한다.", "...", "[수상한 쪽지]를 획득했다."],
        "201": ["201번 사물함을 조사한다.", "...", "사물함은 텅텅 비어있다."],
        "202": ["202번 사물함을 조사한다.", "...", "옷가지가 몇 개 있다.", "지금 필요한 물건은 아닌 것 같다."],
        "203": ["203번 사물함을 조사한다.", "...", "고장난 장비가 있습니다."],
        "301": ["301번 사물함을 조사한다.", "...", "옆에 송 강사님의 사물함이라는 포스트잇이 붙어있다.", "강사님 말씀대로라면 이 사물함 안에 내가 찾는 열쇠가 있을 거다.", "하지만 비밀번호로 잠겨있다.", "비밀번호를 알아내야 열 수 있을 것 같은데.. 혹시 주변에 뭔가 단서가 없는지 살펴보자."],
        "302": ["302번 사물함을 조사한다.", "...", "사물함은 텅텅 비어있다."],
        "303": ["303번 사물함을 조사한다.", "...", "쓸모없는 서류들이 들어있다."],
        "502": ["그런 번호의 사물함은 존재하지 않는...", "어?", "잘 보니 있을 리가 없는 502번 사물함이 정 가운데에 있다.", "502번 사물함을 조사한다.", "...", "[옛날 신문기사]를 획득했다.", "대체 이게 어떻게 된 일이지.."],
        "default": ["그런 번호의 사물함은 존재하지 않는다. 다시 생각해보자."]
    };

    // document.addEventListener('click', function(event) {
    // console.log('Mouse X: ' + event.clientX + ', Mouse Y: ' + event.clientY); // 실험용
    // });

    // 인벤토리 관련 변수 및 함수
    let inventory = [];
    let inventoryImages = []; // 소지품 이미지들을 저장할 배열
    let inventoryText, inventoryBag, modal, modalBackground, modalText;
    let modalItems = []; // 모달에 추가된 소지품 이미지들을 저장할 배열

    const createInventory = (scene) => {
    // 가방 이미지 추가
    inventoryBag = scene.add.image(1150, 40, 'bag').setInteractive();
    inventoryBag.setScale(0.5).setScrollFactor(0);
    inventoryBag.on('pointerdown', () => {
        toggleInventoryModal(scene);
    });
    inventoryBag.on('pointerover', () => {
        document.body.style.cursor = 'pointer';
    });
    inventoryBag.on('pointerout', () => {
        document.body.style.cursor = 'default';
    });

    // 모달 창 생성
    modalBackground = scene.add.rectangle(scene.cameras.main.centerX, scene.cameras.main.centerY - 180, 800, 300, 0xFFFAFA).setAlpha(0).setInteractive().setScrollFactor(0); // 배경색 변경 예시
    modalText = scene.add.text(scene.cameras.main.centerX, 60, '소지품', {
        fontFamily: 'KyoboHandwriting2023wsa',
        fontSize: '24px',
        fill: '#000000'
    }).setAlpha(0).setOrigin(0.5).setScrollFactor(0);
    modal = scene.add.container(0, 0, [modalBackground, modalText]).setAlpha(0);
    };

    // 소지품 칸에 아이템을 추가하는 함수
    const addItemToInventory = (item, imageKey) => {
        // 아이템이 이미 소지품에 있는지 확인
        if (!inventory.includes(item)) {
        inventory.push(item);
        inventoryImages.push({key: imageKey, name: item}); // 소지품 이미지와 이름을 저장
        updateInventoryDisplay();
        } else {
        console.log('아이템이 이미 소지품에 있습니다.');
        }
    };

    // 소지품 칸의 내용을 업데이트하는 함수
    const updateInventoryDisplay = () => {
        if (inventoryText) {
        inventoryText.setText(inventory.map(item => item.name).join('\n'));
        }
    };

    // 아이템 세부 정보를 표시하는 함수
    const showItemDetails = (scene, itemKey) => {
        // 확대해서 보여줄 이미지를 설정
        let enlargedImageKey;
        if (itemKey === 'memo1') {
        enlargedImageKey = 'memo1-1'; // memo1 클릭 시 보여줄 이미지
        } else if (itemKey === 'memo2') {
        enlargedImageKey = 'memo2-1'; // memo2 클릭 시 보여줄 이미지
        }

        // 전체화면 이미지를 추가하고 보이게 설정
        const fullscreenImage = scene.add.image(scene.cameras.main.centerX, scene.cameras.main.centerY, enlargedImageKey)
        .setDisplaySize(scene.cameras.main.width * 0.9, scene.cameras.main.height * 0.9)
        .setAlpha(0)
        .setInteractive();

        scene.tweens.add({
        targets: fullscreenImage,
        alpha: 1,
        duration: 500
        });

        // 클릭 이벤트를 추가하여 이미지를 클릭하면 페이드 아웃하고 제거
        fullscreenImage.on('pointerdown', () => {
        scene.tweens.add({
            targets: fullscreenImage,
            alpha: 0,
            duration: 500,
            onComplete: () => {
            fullscreenImage.destroy();
            }
        });
        });
    };

    // 인벤토리 모달 창을 토글하는 함수
    const toggleInventoryModal = (scene) => {
        if (modal.alpha === 0) {
            // 모달을 보이게 설정
            modal.setAlpha(1);
            modalBackground.setAlpha(0.8);
            modalText.setAlpha(1);

            // 소지품 이미지를 모달에 추가
            inventoryImages.forEach((imageObj, index) => {
                const itemImage = scene.add.image(scene.cameras.main.centerX - 300 + (index % 4) * 200, scene.cameras.main.centerY - 190 + Math.floor(index / 4) * 140, imageObj.key).setScale(0.3).setScrollFactor(0);
                const itemText = scene.add.text(scene.cameras.main.centerX - 300 + (index % 4) * 200, scene.cameras.main.centerY - 100 + Math.floor(index / 4) * 140, imageObj.name, {
                    fontFamily: 'KyoboHandwriting2023wsa',
                    fontSize: '25px', // 폰트 크기 조절
                    fill: '#000000'
                }).setOrigin(0.5).setScrollFactor(0);
                modal.add([itemImage, itemText]);
                modalItems.push(itemImage); // 추가된 소지품 이미지를 저장
                modalItems.push(itemText); // 추가된 소지품 텍스트를 저장

                // 메모 아이템에 대한 클릭 이벤트 추가
                if (imageObj.key === 'memo1' || imageObj.key === 'memo2') {
                    itemImage.setInteractive();
                    itemImage.on('pointerdown', () => {
                    showItemDetails(scene, imageObj.key);
                    });
                }
            });
        } else {
            // 모달을 숨김
            modal.setAlpha(0);
            modalBackground.setAlpha(0);
            modalText.setAlpha(0);

            // 모달에 추가된 소지품 이미지를 제거
            modalItems.forEach(item => item.destroy());
            modalItems = []; // 소지품 이미지 배열 초기화
        }
    };

    // showDialog 함수 수정
    function showDialog(scene, texts) {
        disableClickableZones(); // 클릭 가능한 영역 비활성화
        currentTexts = texts;
        currentTextIndex = 0;
        dialogBox.setVisible(true);
        dialogText.setVisible(true);
        dialogText.setText(currentTexts[currentTextIndex]);

        if (texts === texts1) {
            dialogBox.off('pointerdown');  // 이전 이벤트 리스너 제거
            dialogBox.on('pointerdown', advanceDialogueWithInput);
        } else {
            dialogBox.off('pointerdown');  // 이전 이벤트 리스너 제거
            dialogBox.on('pointerdown', advanceDialogue);
        }
    }

    // 이미지 표시 함수
    const showItemImage = (imageKey) => {
        const scene = game.scene.scenes[0];  // 현재 씬 참조
        const itemImage = scene.add.image(config.width / 2, config.height / 2, imageKey).setScale(0.5).setAlpha(0);
        scene.tweens.add({
            targets: itemImage,
            alpha: 1,
            duration: 150,
            yoyo: true,
            hold: 500,
            onComplete: () => {
                itemImage.destroy();
            }
        });
    };

    // 아이템 획득 처리 함수
    const handleItemAcquisition = (text) => {
        if (text === "[수상한 유리병]을 획득했다.") {
            console.log("수상한 유리병 획득");
            showItemImage('glass');
            addItemToInventory("수상한 유리병", "glass");
        } else if (text === "[수상한 쪽지]를 획득했다.") {
            console.log("수상한 쪽지 획득");
            showItemImage('letter');
            addItemToInventory("수상한 쪽지", "letter");
        } else if (text === "[옛날 신문기사]를 획득했다.") {
            console.log("옛날 신문기사 획득");
            showItemImage('newspaper');
            addItemToInventory("옛날 신문기사", "newspaper");
        }
    };

    function advanceDialogue() {
        currentTextIndex++;
        if (currentTextIndex < currentTexts.length) {
            dialogText.setText(currentTexts[currentTextIndex]);
            handleItemAcquisition(currentTexts[currentTextIndex]);
        } else {
            dialogBox.setVisible(false);
            dialogText.setVisible(false);
            enableClickableZones(); // 클릭 가능한 영역 다시 활성화
        }
    }

    // texts1일 경우에만 inputBox 나오도록 따로 함수 지정
    function advanceDialogueWithInput() {
        currentTextIndex++;
        if (currentTextIndex < currentTexts.length) {
            dialogText.setText(currentTexts[currentTextIndex]);
        } else {
            dialogText.setText("조사할 사물함의 번호를 입력해주세요.(101 ~ 303)");
            document.getElementById('inputBox').style.display = 'inline-block';
            document.getElementById('submitButton').style.display = 'inline-block';
            
            document.getElementById('submitButton').onclick = function() {
                const inputNumber = document.getElementById('inputBox').value;
                handleInputNumber(inputNumber);
            };
        }
    }

    // 입력받은 사물함 번호에 따라서 처리 방식 지정 함수
    function handleInputNumber(inputNumber) {
        let selectedTexts = textsMap[inputNumber] || textsMap["default"];
        currentTexts = selectedTexts;
        currentTextIndex = 0;
        document.getElementById('inputBox').style.display = 'none';
        document.getElementById('submitButton').style.display = 'none';
        dialogText.setText(currentTexts[currentTextIndex]);

        dialogBox.off('pointerdown');  // 이전 이벤트 리스너 제거
        dialogBox.on('pointerdown', function() {
            currentTextIndex++;
            if (currentTextIndex < currentTexts.length) {
                dialogText.setText(currentTexts[currentTextIndex]);
                handleItemAcquisition(currentTexts[currentTextIndex]);
            } else {
                dialogBox.setVisible(false);
                dialogText.setVisible(false);
                enableClickableZones(); // 클릭 가능한 영역 다시 활성화
            }
        });
    }

    // 클릭 가능한 영역을 비활성화 후 다시 활성화하는 함수(클릭영역과 dialogBox 영역 중복 회피)
    function disableClickableZones() {
        clickableZones.forEach(zone => zone.disableInteractive());
    }

    function enableClickableZones() {
        clickableZones.forEach(zone => zone.setInteractive());
    }

    // 공통 클릭 영역 생성 함수
    function createClickableZone(scene, x, y, width, height, clickHandler) {
        const zone = scene.add.zone(x, y, width, height).setOrigin(0.5).setInteractive();
        zone.on('pointerover', () => {
            document.body.style.cursor = 'pointer';
        });
        zone.on('pointerout', () => {
            document.body.style.cursor = 'default';
        });
        zone.on('pointerdown', () => {
            clickHandler();
        });
        clickableZones.push(zone); // 클릭 가능한 영역을 배열에 추가
        return zone;
    }

    // 공통 클릭 영역 제거 함수
    function clearClickableAreas() {
        clickableZones.forEach(zone => zone.destroy());
        clickableZones = [];
    }

    // 특정 클릭 가능한 영역을 제거하는 함수
    function clearSpecificClickableArea(zone) {
        zone.destroy();
        clickableZones = clickableZones.filter(z => z !== zone);
    }

    // 사물함 내부 영역 제거 함수
    function clearLockerArea() {
        clickableZones.forEach(zone => {
            if (zone) zone.destroy();
        });
        clickableZones = [];
    }

    // 클릭 가능한 영역을 생성하는 함수
    function createClickableAreas(scene) {
        // 사물함 클릭 영역
        createClickableZone(scene, 219.5, 280.5, 233, 259, () => {
            changeBackground(scene, 'locker'); // 배경 이미지 변경
            hideNavButtons(); // 좌우 버튼 숨기기
            showBackButton(); // 뒤로 가기 버튼 보이기
            createLockerClickableArea(scene); // 사물함 내부 클릭 영역 생성
        });

        // 전자레인지 클릭 영역
        createClickableZone(scene, 573, 339.5, 236, 141, () => {
            changeBackground(scene, 'microwave'); // 배경 이미지 변경
            hideNavButtons(); // 좌우 버튼 숨기기
            showBackButton(); // 뒤로 가기 버튼 보이기
            createMicrowaveClickableArea(scene); // 전자레인지 내부 클릭 영역 생성
        });

        // 테이블1 클릭 영역
        createClickableZone(scene, 936, 347.5, 292, 125, () => {
            showDialog(scene, texts3_1);
        });

        // 테이블2 클릭 영역
        createClickableZone(scene, 1294.5, 347.5, 293, 125, () => {
            showDialog(scene, texts3_2);
        });

        // 게시판 클릭 영역
        createClickableZone(scene, 1132, 154.5, 168, 113, () => {
            showDialog(scene, texts3_3);
        });

        // 비상계단문 클릭 영역
        createClickableZone(scene, 1591, 282.5, 130, 255, () => {
            showDialog(scene, texts4);
        });

        // 엘리베이터 클릭 영역
        createClickableZone(scene, 1944, 271.5, 346, 277, () => {
            showDialog(scene, texts5);
        });
    }

    // 사물함 내부 클릭 영역
    function createLockerClickableArea(scene) {
        const lockerZone = scene.add.zone(216, 147, 747, 567).setOrigin(0, 0).setInteractive(); // 좌표와 크기 설정
        lockerZone.on('pointerover', () => {
            document.body.style.cursor = 'pointer';
        });
        lockerZone.on('pointerout', () => {
            document.body.style.cursor = 'default';
        });
        lockerZone.on('pointerdown', () => {
            showDialog(scene, texts1);
        });
        clickableZones.push(lockerZone); // 클릭 가능한 영역을 배열에 추가
    }

    // 전자레인지 내부 클릭 영역
        function createMicrowaveClickableArea(scene) {
        const microwaveZone = scene.add.zone(537.5, 462.5, 647, 209).setOrigin(0.5).setInteractive(); // 좌표와 크기 설정
        microwaveZone.on('pointerover', () => {
            document.body.style.cursor = 'pointer';
        });
        microwaveZone.on('pointerout', () => {
            document.body.style.cursor = 'default';
        });
        microwaveZone.on('pointerdown', () => {
            showDialog(scene, texts2);
        });
        clickableZones.push(microwaveZone); // 클릭 가능한 영역을 배열에 추가
    }

    // 배경 이미지 변경 함수
    function changeBackground(scene, textureKey) {
        clearClickableAreas(); // 기존 클릭 가능한 영역 제거
        bgImage.setTexture(textureKey); // 배경 이미지 변경
        let scaleX = config.width / bgImage.width;
        let scaleY = config.height / bgImage.height;
        let scale = Math.max(scaleX, scaleY);
        bgImage.setScale(scale).setOrigin(0, 0); // 화면 꽉 차게 스케일 조정

        // 내부 클릭 영역 재생성
        if (textureKey === 'locker') {
            createLockerClickableArea(scene);
        } else if (textureKey === 'microwave') {
            createMicrowaveClickableArea(scene);
        }
    }

    // 좌우 버튼 숨기기 함수
    function hideNavButtons() {
        document.getElementById('prev-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
    }

    // 뒤로가기 버튼 표시 함수
    function showBackButton() {
        document.getElementById('back-button').style.display = 'block';
    }

    // 뒤로가기 버튼 기능 함수
    function goBack() {
        bgImage.setTexture('background'); // 원래 배경 이미지로 변경
        let scaleX = config.width / bgImage.width;
        let scaleY = config.height / bgImage.height;
        let scale = Math.max(scaleX, scaleY);
        bgImage.setScale(scale).setOrigin(0, 0); // 화면 꽉 차게 스케일 조정
        document.getElementById('back-button').style.display = 'none'; // 뒤로 가기 버튼 숨기기
        document.getElementById('prev-button').style.display = 'block'; // 좌우 버튼 다시 보이기
        document.getElementById('next-button').style.display = 'block';
        clearClickableAreas(); // 내부 클릭 영역 제거
        createClickableAreas(game.scene.scenes[0]); // 클릭 가능한 영역 다시 생성

        // 커서를 기본값으로 되돌리기
        document.body.style.cursor = 'default';
    }

    function preload() {
        this.load.image('background', 'images/7floorBD.png');
        this.load.image('locker', 'images/floor7_locker.png');
        this.load.image('microwave', 'images/floor7_microwave.png');
        this.load.image('letter', 'images/letter.png');
        this.load.image('glass', 'images/glassBottle.png');
        this.load.image('photo', 'images/photo.png');
        this.load.image('newspaper', 'images/newspaper.png');
        this.load.image('dialogueBox', 'images/wallpaper-torn-paper-ripped-white-paper.png');
        this.load.image('bag', 'images/bag.svg');
    }

    function create() {
        bgImage = this.add.image(0, 0, 'background').setOrigin(0, 0);

        let scaleX = config.width / bgImage.width;
        let scaleY = config.height / bgImage.height;
        let scale = Math.max(scaleX, scaleY);

        bgImage.setScale(scale).setOrigin(0, 0);

        camera = this.cameras.main;
        camera.setViewport(0, 0, config.width, config.height);

        sectionWidth = (bgImage.displayWidth - config.width) / (totalSections - 1);

        dialogBox = this.add.image(config.width / 2, 530, 'dialogueBox').setOrigin(0.5, 0).setInteractive();
        dialogBox.setVisible(false);

        dialogText = this.add.text(config.width / 2, config.height - 70, '', {
            fontFamily: 'KyoboHandwriting2023wsa',
            fontSize: '35px',
            fill: '#000000',
            wordWrap: { width: 1000, useAdvancedWrap: true }
        }).setOrigin(0.5).setAlign('center');
        dialogText.setVisible(false);

        createInventory(this);  // 소지품 칸 초기화 호출

        createClickableAreas(this); // 클릭 가능한 영역 생성
    }

    function viewSection(direction) {
        if (dialogBox.visible) return;

        currentSection += direction;
        if (currentSection < 0) currentSection = 0;
        if (currentSection >= totalSections) currentSection = totalSections - 1;

        camera.scrollX = sectionWidth * currentSection;
        camera.scrollY = 0;
    }

    // 섹션에 따라서 카메라의 스크롤 위치 변경
    function update() {
        const cameraScrollX = camera.scrollX;

        dialogBox.setPosition(cameraScrollX + config.width / 2, 530);
        dialogText.setPosition(cameraScrollX + config.width / 2, config.height - 70);
    }
    </script>
</body>
</html>