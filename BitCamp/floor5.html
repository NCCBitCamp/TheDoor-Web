<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5층 배경</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'KyoboHandwriting2023wsa', sans-serif;
            cursor: default;
        }
        #game-container {
            position: relative;
            width: 1280px;
            height: 720px;
            margin: 0 auto;
            overflow: hidden;
        }
        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: white;
            color: black;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }
        #prev-button {
            left: 0;
            font-family: 'KyoboHandwriting2023wsa';
        }
        #next-button {
            right: 0;
            font-family: 'KyoboHandwriting2023wsa';
        }
        @font-face {
            font-family: 'KyoboHandwriting2023wsa';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2404-2@1.0/KyoboHandwriting2023wsa.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <button id="prev-button" class="nav-button" onclick="viewSection(-1)"><</button>
        <button id="next-button" class="nav-button" onclick="viewSection(1)">></button>
    </div>

    <script>
        var config = {
            type: Phaser.AUTO,
            width: 1280,
            height: 720,
            parent: 'game-container',
            scene: {
                preload: preload,
                create: create
            }
        };

        var game = new Phaser.Game(config);
        var camera;
        var bgImage;
        var currentSection = 0;
        var totalSections = 3;
        var sectionWidth;
        var alertIcon;
        var dialogBox;
        var dialogText;
        var teacherImage;
        var noteImage;
        var dialogueLines = [
            "???: 아니 이게 왜 안되지?",
            "문을 여니 컴퓨터 키보드를 두드리는 소리와 함께 익숙한 목소리가 들려온다.",
            "분명 이게 맞을텐데.. 어?",
            "우리 반의 코딩교육을 담당하시는 고강사님, 학생들보다 열심히 공부하실만큼 성실하시지만 살짝 허당끼도 있으셔서 많은 학생들에게 인기있는 강사님이다.",
            "xx님이 어떻게 여길..",
            "(지금까지의 일을 설명한다.)",
            "그렇게 된거군요. 저도 밤늦게까지 다음주 수업 자료를 준비하다가..",
            "노트북 배터리가 다 되는 바람에 파일을 날려버려서\n다시 작성하다보니 어느샌가 이 곳에 갇혀있었네요.",
            "(이 곳에서 탈출할 방법에 대해 묻는다.)",
            "아마 비상구도 엘리베이터도 사용하기 힘든 상황일 거에요. \n저도 같이 돌아다니고 싶지만 자리를 떠나기 힘든 상황이라..",
            "일단 혼자서라도 주위를 살펴보자. 뭔가 탈출의 단서가 될만한 게 있을지도 모른다."
        ];
        var currentLineIndex = 0;

        // 인벤토리 관련 변수 및 함수
        let inventory = [];
        let inventoryImages = []; // 소지품 이미지들을 저장할 배열
        let inventoryText, inventoryBag, modal, modalBackground, modalText;
        let modalItems = []; // 모달에 추가된 소지품 이미지들을 저장할 배열

        // 소지품 칸을 초기화하는 함수
        const createInventory = (scene) => {
          // 가방 이미지 추가
          inventoryBag = scene.add.image(100, 100, 'bag').setInteractive();
          inventoryBag.setScale(0.5);
          inventoryBag.on('pointerdown', () => {
            toggleInventoryModal(scene);
          });
          inventoryBag.on('pointerover', () => {
            document.body.style.cursor = 'pointer';
          });
          inventoryBag.on('pointerout', () => {
            document.body.style.cursor = 'default';
          });

          // 모달 창 생성
          modalBackground = scene.add.rectangle(scene.cameras.main.centerX, scene.cameras.main.centerY - 180, 800, 300, 0xFFFAFA).setAlpha(0).setInteractive(); // 배경색 변경 예시
          modalText = scene.add.text(scene.cameras.main.centerX, 60, '소지품', {
            fontFamily: 'KyoboHandwriting2023wsa',
            fontSize: '24px',
            fill: '#000000'
          }).setAlpha(0).setOrigin(0.5);
          modal = scene.add.container(0, 0, [modalBackground, modalText]).setAlpha(0);
        };

        // 소지품 칸에 아이템을 추가하는 함수
        const addItemToInventory = (item, imageKey) => {
          // 아이템이 이미 소지품에 있는지 확인
          if (!inventory.includes(item)) {
            inventory.push(item);
            inventoryImages.push({key: imageKey, name: item}); // 소지품 이미지와 이름을 저장
            updateInventoryDisplay();
          } else {
            console.log('아이템이 이미 소지품에 있습니다.');
          }
        };

        // 소지품 칸의 내용을 업데이트하는 함수
        const updateInventoryDisplay = () => {
          if (inventoryText) {
            inventoryText.setText(inventory.map(item => item.name).join('\n'));
          }
        };

        // 아이템 세부 정보를 표시하는 함수
        const showItemDetails = (scene, itemKey) => {
          // 확대해서 보여줄 이미지를 설정
          let enlargedImageKey;
          if (itemKey === 'memo1') {
            enlargedImageKey = 'memo1-1'; // memo1 클릭 시 보여줄 이미지
          } else if (itemKey === 'memo2') {
            enlargedImageKey = 'memo2-1'; // memo2 클릭 시 보여줄 이미지
          }

          // 전체화면 이미지를 추가하고 보이게 설정
          const fullscreenImage = scene.add.image(scene.cameras.main.centerX, scene.cameras.main.centerY, enlargedImageKey)
            .setDisplaySize(scene.cameras.main.width * 0.9, scene.cameras.main.height * 0.9)
            .setAlpha(0)
            .setInteractive();

          scene.tweens.add({
            targets: fullscreenImage,
            alpha: 1,
            duration: 500
          });

          // 클릭 이벤트를 추가하여 이미지를 클릭하면 페이드 아웃하고 제거
          fullscreenImage.on('pointerdown', () => {
            scene.tweens.add({
              targets: fullscreenImage,
              alpha: 0,
              duration: 500,
              onComplete: () => {
                fullscreenImage.destroy();
              }
            });
          });
        };

        // 인벤토리 모달 창을 토글하는 함수
        const toggleInventoryModal = (scene) => {
          if (modal.alpha === 0) {
            // 모달을 보이게 설정
            modal.setAlpha(1);
            modalBackground.setAlpha(0.8);
            modalText.setAlpha(1);

            // 소지품 이미지를 모달에 추가
            inventoryImages.forEach((imageObj, index) => {
              const itemImage = scene.add.image(scene.cameras.main.centerX - 300 + (index % 4) * 200, scene.cameras.main.centerY - 190 + Math.floor(index / 4) * 140, imageObj.key).setScale(0.3);
              const itemText = scene.add.text(scene.cameras.main.centerX - 300 + (index % 4) * 200, scene.cameras.main.centerY - 100 + Math.floor(index / 4) * 140, imageObj.name, {
                fontFamily: 'KyoboHandwriting2023wsa',
                fontSize: '25px', // 폰트 크기 조절
                fill: '#000000'
              }).setOrigin(0.5);
              modal.add([itemImage, itemText]);
              modalItems.push(itemImage); // 추가된 소지품 이미지를 저장
              modalItems.push(itemText); // 추가된 소지품 텍스트를 저장

              // 메모 아이템에 대한 클릭 이벤트 추가
              if (imageObj.key === 'memo1' || imageObj.key === 'memo2') {
                itemImage.setInteractive();
                itemImage.on('pointerdown', () => {
                  showItemDetails(scene, imageObj.key);
                });
              }
            });
          } else {
            // 모달을 숨김
            modal.setAlpha(0);
            modalBackground.setAlpha(0);
            modalText.setAlpha(0);

            // 모달에 추가된 소지품 이미지를 제거
            modalItems.forEach(item => item.destroy());
            modalItems = []; // 소지품 이미지 배열 초기화
          }
        };

        function preload() {
            this.load.image('background', 'images/5floorBD.png');
            this.load.image('alert', 'images/alert.png');
            this.load.image('teacher', 'images/teacher.png');
            this.load.image('dialogueBox', 'images/wallpaper-torn-paper-ripped-white-paper.png');
            this.load.image('bag', 'images/bag.svg');
          }

        function create() {
            bgImage = this.add.image(0, 0, 'background').setOrigin(0, 0);
            
            var scaleX = config.width / bgImage.width;
            var scaleY = config.height / bgImage.height;
            var scale = Math.max(scaleX, scaleY);
            
            bgImage.setScale(scale).setOrigin(0, 0);
            
            camera = this.cameras.main;
            camera.setViewport(0, 0, config.width, config.height);
            
            sectionWidth = (bgImage.displayWidth - config.width) / (totalSections - 1);

            alertIcon = this.add.image(1000, 200, 'alert').setInteractive();
            alertIcon.setScale(0.5); 
            alertIcon.on('pointerdown', showDialog);

            teacherImage = this.add.image(920, 400, 'teacher');
            teacherImage.setScale(0.25);
            teacherImage.setVisible(false);

            dialogBox = this.add.image(config.width / 2, 530, 'dialogueBox').setOrigin(0.5, 0).setInteractive();
            dialogBox.setVisible(false);
            dialogBox.on('pointerdown', showDialog);

            dialogText = this.add.text(config.width / 2, config.height - 70, '', {
                fontFamily: 'KyoboHandwriting2023wsa',
                fontSize: '35px',
                fill: '#000000',
                wordWrap: { width: 1000, useAdvancedWrap: true }
            }).setOrigin(0.5).setAlign('center');
            dialogText.setVisible(false);

            createInventory(this);  // 소지품 칸 초기화 호출
        }

        function viewSection(direction) {
            if (dialogBox.visible) return;

            currentSection += direction;
            if (currentSection < 0) currentSection = 0;
            if (currentSection >= totalSections) currentSection = totalSections - 1;

            camera.scrollX = sectionWidth * currentSection;
            camera.scrollY = 0;
        }

        function showDialog() {
            if (currentLineIndex === 0) {
                dialogBox.setVisible(true);
                dialogText.setVisible(true);
                document.getElementById("prev-button").disabled = true;
                document.getElementById("next-button").disabled = true;
            }
            if (currentLineIndex === 2) {
                teacherImage.setVisible(true);
            }
            if (currentLineIndex < dialogueLines.length) {
                dialogText.setText(dialogueLines[currentLineIndex]);
                currentLineIndex++;
            } else {
                dialogBox.setVisible(false);
                dialogText.setVisible(false);
                teacherImage.setVisible(false);
                currentLineIndex = 0;
                document.getElementById("prev-button").disabled = false;
                document.getElementById("next-button").disabled = false;
            }
        }
    </script>
</body>
</html>
